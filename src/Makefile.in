LIBNAME    =iemmatrix

PREFIX     =@prefix@@PDLIBDIR@

INSTALL_BIN=$(PREFIX)/extra
INSTALL_DOC=$(PREFIX)/@REFERENCEPATH@$(LIBNAME)

EXT = @EXT@ 
DEFS = @DFLAGS@
IFLAGS = -I. @INCLUDES@ $(INCLUDES)
MAKEDEP_FLAGS = @MAKEDEP_FLAGS@

CC = @CC@
LD = @LD@
STRIP = @STRIP@

AFLAGS = 
LFLAGS = @LFLAGS@
WFLAGS =

TARNAME =  $(LIBNAME)-@IEMMATRIX_VERSION@.tgz

.SUFFIXES: .$(EXT)

CFLAGS = $(DEFS) $(IFLAGS) $(WFLAGS) @CFLAGS@ 

LIBS = @LIBS@

SOURCES=$(sort $(filter %.c, $(wildcard mtx_*.c))) iemmatrix.c
TARGETS = $(SOURCES:.c=.o) 

all: $(LIBNAME)
	cp $(LIBNAME).$(EXT) ..

$(LIBNAME): $(TARGETS)
	$(LD) $(LFLAGS) -o $(LIBNAME).$(EXT) *.o $(LIBS)
	$(STRIP) @STRIPFLAGS@ $(LIBNAME).$(EXT)

## dependencies: as proposed by the GNU-make documentation
## see http://www.gnu.org/software/make/manual/html_node/make_47.html#SEC51
-include $(SOURCES:.c=.d)
%.d: %.c
	@set -e; rm -f $@; \
	$(CXX) $(MAKEDEP_FLAGS) $(CFLAGS) $< > $@.$$$$; \
	sed 's,\($*\)\.o[ :]*,\1.o $@ : ,g' < $@.$$$$ > $@; \
	rm -f $@.$$$$

clean:
	-rm -f *.$(EXT) *.o 

cleaner: clean
	-rm -f *~ _* config.* *.d *.d.*

cleanest: cleaner
	-rm -f Makefile ../*.$(EXT) 

distclean: cleanest newmakefile

install: install-bin install-doc

install-bin:
	-install -d $(INSTALL_BIN)
	-install -m 644 $(LIBNAME).$(EXT) $(INSTALL_BIN)

install-doc:
	-install -d $(INSTALL_DOC)
	-install -m 644 ../doc/*.pd $(INSTALL_DOC)

dist: all cleaner
	(cd ../..;tar czvf $(TARNAME) $(LIBNAME))

everything: clean all install distclean

newmakefile:
	echo "current:">Makefile
	echo "	./configure && make">>Makefile

Makefile: Makefile.in configure
	./configure

configure: configure.ac
	autoconf
